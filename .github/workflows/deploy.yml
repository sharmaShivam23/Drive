

# name: CI/CD Pipeline for Node Backend

# on:
#   push:
#     branches:
#       - main  # Trigger only when pushing to main branch

# jobs:
#   build_and_deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # Step 1: Checkout code
#       - name: Checkout Repository
#         uses: actions/checkout@v3

#       # Step 2: Build Docker image
#       - name: Build Docker Image
#         run: docker build -t shivam232006/backend:latest .

#       # Step 3: Login to Docker Hub
#       - name: Login to Docker Hub
#         run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

#       # Step 4: Push image to Docker Hub
#       - name: Push Image to Docker Hub
#         run: docker push shivam232006/backend:latest

#       # Step 5: Deploy to EC2 via SSH
#       - name: Deploy to EC2 via SSH
#         uses: appleboy/ssh-action@v0.1.10
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           port: 22
#           script: |
#             echo "Pulling latest Docker image..."
#             sudo docker pull shivam232006/backend:latest

#             echo "Stopping old container..."
#             sudo docker stop backend || true
#             sudo docker rm backend || true

#             echo "Running new container..."
#             sudo docker run -d --name backend -p 5000:5000 --env-file /home/${{ secrets.EC2_USER }}/.env --restart always shivam232006/backend:latest

#             echo "Cleaning old images..."
#             sudo docker image prune -f




name: CI/CD Pipeline for Node Backend

on:
  push:
    branches:
      - main  # Trigger only when pushing to main branch

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Build Docker image
      - name: Build Docker Image
        run: docker build -t shivam232006/backend:latest .

      # Step 3: Login to Docker Hub
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Step 4: Push image to Docker Hub
      - name: Push Image to Docker Hub
        run: docker push shivam232006/backend:latest

      # Step 5: Deploy to EC2 via SSH
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "Stopping and removing old container if exists..."
            if [ $(sudo docker ps -a -q -f name=backend) ]; then
                sudo docker stop backend || true
                sudo docker rm backend || true
            fi

            echo "Pulling latest Docker image..."
            sudo docker pull shivam232006/backend:latest

            echo "Running new container..."
            sudo docker run -d --name backend -p 5000:5000 \
                --env-file /home/${{ secrets.EC2_USER }}/.env \
                --restart always \
                shivam232006/backend:latest

            echo "Cleaning up dangling images..."
            sudo docker images -f "dangling=true" -q | xargs -r sudo docker rmi -f
